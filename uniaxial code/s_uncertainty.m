function [u_trans, u_refl] = s_uncertainty(S21,S11)

% calculate the uncertainty of the transmission and reflection coefficients
%  the uncertainty is dependent on the magnitude of the tx/refl coefficient
% inputs: complex valued S11 and S12
% outputs: complex valued transmission uncertainty, complex valued reflection uncertainty
% rad2deg=@(x) x.*(180/pi);
% deg2rad=@(x) x.*(pi/180);
% reflection coefficient is in linear units
x=[0.00114368 0.0176514 0.0297538 0.0407573 0.0583639 0.0693698 0.0847761 ...
    0.101283 0.115588 0.125489 0.139794 0.1552 0.168406 0.180507 0.194814 ...
    0.21022 0.234426 0.266339 0.27954 0.296047 0.313651 0.335659 0.363164 ...
    0.38187 0.404976 0.422582 0.45339 0.473193 0.503997 0.531505 0.54691 ...
    0.568911 0.63932 0.660227 0.675628 0.711931 0.719631 0.722928 0.784531 ...
    0.817534 0.847235 0.871434 0.89783 0.913232 0.92753 0.946228 0.964928 ...
    0.977024 1.00122]; % reflection coefficient
y=[0.00350184 0.00398661 0.00408271 0.0042762 0.00466359 0.00505162 0.00543923 ...
    0.00582673 0.00611717 0.0061162 0.00640664 0.00679425 0.00718207 0.00718089 ...
    0.00756861 0.00795621 0.00824569 0.0090208 0.00901951 0.00940701 0.00959985 ...
    0.0100841 0.010276 0.010566 0.0108556 0.011243 0.0116291 0.0117244 0.0118187 ...
    0.0122051 0.0124955 0.012396 0.0125837 0.0129708 0.012872 0.0128685 0.0127705 ...
    0.0124783 0.0122778 0.0122746 0.0120771 0.0117829 0.011294 0.0112925 0.0109993 ...
    0.0107056 0.0106065 0.010119 0.0098248]; % uncertainties for reflection coefficient
pp=csaps(x,y);
u_refl_mag=ppval(pp,abs(S11));

% Reflection phase
x=[0.0196694000000000,0.0218573000000000,0.0218948000000000,0.0283345000000000,0.0283664000000000,...
    0.0347891000000000,0.0369395000000000,0.0390898000000000,0.0412425000000000,0.0433895000000000,...
    0.0465968000000000,0.0679813000000000,0.0519455000000000,0.0615711000000000,0.0701260000000000,...
    0.0744017000000000,0.0797459000000000,0.0904148000000000,0.0989538000000000,0.110694000000000,...
    0.128832000000000,0.141635000000000,0.158702000000000,0.176833000000000,0.191766000000000,...
    0.208823000000000,0.214157000000000,0.233354000000000,0.246151000000000,0.262144000000000,...
    0.282404000000000,0.304797000000000,0.329322000000000,0.361307000000000,0.394360000000000,...
    0.415687000000000,0.448736000000000,0.470059000000000,0.502045000000000,0.530834000000000,...
    0.564952000000000,0.594802000000000,0.626791000000000,0.669439000000000,0.695030000000000,...
    0.724881000000000,0.750470000000000,0.813376000000000,0.843231000000000,0.879480000000000,...
    0.905069000000000,0.931724000000000,0.954115000000000,0.991434000000000,0.997830000000000];
y=[10.0393000000000,9.08602000000000,8.44400000000000,7.70482000000000,7.16008000000000,6.71273000000000,...
    6.40149000000000,6.09025000000000,5.74010000000000,5.48722000000000,5.33164000000000,4.26202000000000,...
    5.02046000000000,4.49536000000000,4.04805000000000,3.85358000000000,3.62023000000000,3.48425000000000,...
    3.30931000000000,3.07608000000000,2.84297000000000,2.66812000000000,2.51281000000000,2.37698000000000,...
    2.26054000000000,2.26087000000000,2.20261000000000,2.08625000000000,2.00868000000000,1.98953000000000,...
    1.91211000000000,1.83472000000000,1.75738000000000,1.71909000000000,1.64191000000000,1.56451000000000,...
    1.56515000000000,1.54611000000000,1.48837000000000,1.41110000000000,1.37286000000000,1.37344000000000,...
    1.27678000000000,1.19979000000000,1.12247000000000,1.12305000000000,1.08464000000000,0.969131000000000,...
    0.891891000000000,0.873141000000000,0.834728000000000,0.776881000000000,0.738406000000000,0.641856000000000,...
    0.641981000000000];
pp=csaps(x,y);
u_refl_phase=ppval(pp,abs(S11));  % in degrees

% transmission magnitude (transmission coefficient in dBm)
x=[0 0.546117 1.31068 1.74757 2.73058 3.2767 4.15049 5.1335 6.1165...
    7.20874 7.9733 8.73786 10.4854 11.9053 13.216 14.3083 18.0218...
    22.5 28.2888 33.9684 42.3786 49.1505 53.5194 57.233 60.7282 64.6602...
    68.9199 70.9951 74.7087 77.2209 80.4976 83.3374 85.1942 86.5049...
    88.5801 90.1092]; % these are really negative values, but i input them as positive to ease comparison in matlab
y=[0.0399211 0.0471353 0.0723968 0.0854798 0.0995396 0.114318 0.127706...
    0.134977 0.146667 0.157178 0.163843 0.166127 0.173172 0.190792 0.188169...
    0.185583 0.196149 0.198883 0.213136 0.216107 0.231595 0.231595 0.241416...
    0.255161 0.26598 0.269688 0.285043 0.29713 0.305471 0.318424 0.350825...
    0.365701 0.375968 0.39191 0.437807 0.456372];
pp=csaps(x,y);
S21db=20*log10(abs(S21));  
u_trans_mag_db=ppval(pp,abs(S21db)); % in dbm, abs accounts for my conversion to positive x vals
% u_trans_mag=1-10.^(u_trans_mag_db/20); % convert back to linear for output
u_trans_mag=10.^(-u_trans_mag_db/20)-1; % convert back to linear for output


% transmission phase (again, transmission coefficient in dbm)
x=[0.00867882 0.327068 0.750718 0.964341 1.70613 2.23542 2.97584 3.71602 4.87948...
    5.72492 6.67662 8.15561 10.5858 12.0651 15.6572 18.5093 25.376 31.9254...
    39.4259 45.4471 51.9971 55.2718 59.286 62.6669 68.8997 70.2735 73.865 76.0839...
    79.359 81.6831 83.0566 84.5359 85.8037 86.5436 87.6003 88.7626 90.2423];
y=[0.263538 0.311148 0.352409 0.458419 0.596268 0.675328 0.754331 0.819568...
    0.967502 1.0084 1.12633 1.14177 1.22314 1.27472 1.36532 1.36472 1.4409...
    1.45951 1.54083 1.56086 1.67104 1.69348 1.71603 1.83806 1.91416 2.05091...
    2.0216 2.16574 2.2879 2.31896 2.38356 2.51869 2.5533 2.69837 2.81233...
    2.93107 3.18419];
pp=csaps(x,y);
u_trans_phase=ppval(pp,abs(S21db)); % in degrees


u_trans=u_trans_mag*exp(1j*deg2rad(u_trans_phase));
u_refl=u_refl_mag*exp(1j*deg2rad(u_refl_phase));
